# Authorization

We use the OAuth 2.0 protocol with PKCE, an industry standard for authorization management.

Make sure you have the _CLIENT ID_ an a _SECRET KEY_ provided by our support team. If you don't have them contact us at <a class="link-primary" href="mailto:info@stratifi.com">support@stratifi.com</a>.

## Authorization Code Flow + PCKE

Following the steps below you will get an access token that can be used to access StratiFi on behalf of the advisor.

> PCKE

```python
import base64
import hashlib
import random
import string

# generate the code verifier
code_verifier = "".join(
    random.choice(string.ascii_uppercase + string.digits)
    for _ in range(random.randint(43, 128))
)
code_verifier = base64.urlsafe_b64encode(code_verifier.encode("utf-8"))

# generate the code challenge
code_challenge = hashlib.sha256(code_verifier).digest()
code_challenge = (
    base64.urlsafe_b64encode(code_challenge).decode("utf-8").replace("=", "")
)
```

1. Generate an authentication code grant with PKCE (Proof Key for Code Exchange).
	- Generate a random strng between 43 and 128 characters, encode it in base64 and save it as `code_verifier`.
	- Hash the `code_verifier` with SHA-256, encode it in base64 and save it as `code_challenge`.

2.  Redirect the advisor to the StratiFi authorization page:

    `https://{{ domain }}/o/authorize/?response_type=code&code_challenge={{ code_challenge }}&code_challenge_method=S256&client_id={{ client_id }}&scope={{ scope }}&state={{ state }}`

    | Parameter             | Description                                                                                                |
    | --------------------- | ---------------------------------------------------------------------------------------------------------- |
    | domain                | StratiFi sandbox or production domain.                                                                     |
    | response_type         | "code"                                                                                                     |
    | state                 | Random string generated by your application. It will be returned along with the code in the response.      |
    | code_challenge        | Random string between 43 and 128 characters encoded with SHA-256. We use it to validate the token request. |
    | code_challenge_method | "S256"                                                                                                     |
    | client_id             | Provided by StratiFi.                                                                                      |
    | scope                 | Required scopes. You will want to use "read write".                                                        |

1.  The advisor submits the StratiFi credentials.

    ![login](https://s3.amazonaws.com/api.stratifi.com/login.2.png "Login")

1.  The advisor allow your application access the resources in StratiFi.

    ![grant](https://s3.amazonaws.com/api.stratifi.com/grant.2.png "Grant")

1.  We redirect the browser to your return url with a single-usage access code.

    `https://{{ callback-url }}code={{ code }}&state={{ state }}`

    | Parameter    | Description                                                                    |
    | ------------ | ------------------------------------------------------------------------------ |
    | callback-url | URL provided by you when during the application setup                          |
    | code         | Single-usage code that can be exchanged by an access token.                    |
    | state        | Random string generated by your application included in the authorization URL. |

1.  Your application backend exchange the access code by an access token.

```shell

curl -X POST "https://backend.stratifi.com/o/token/" \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=authorization_code' \
  --data-urlencode 'client_id={{ client_id }}' \
  --data-urlencode 'client_secret={{ secret_key }}' \
  --data-urlencode 'redirect_uri={{ redirect_url }}' \
  --data-urlencode 'code={{ code }}' \
  --data-urlencode 'code_verifier={{ code_verifier }}'

{
    "access_token": "{{ access_token }}",
    "token_type": "Bearer",
    "expires_in": 3600,
    "refresh_token": "{{ refresh_token }}",
    "scope": "read write",
    "advisor_id": 1,
    "session_token": "{{ session_token }}
}
```

**Request Parameters**

| Parameter     | Type   |                                                |
| ------------- | ------ | ---------------------------------------------- |
| grant_type    | string | Always "authorization_code"                    |
| code          | string | The single-usage code received in the callback |
| code_verifier | string | The random string generated in the first step  |
| redirect_uri  | string | The callback URL                               |
| client_id     | string | Your application client id                     |
| client_secret | string | Your application secret key                    |

**Response**

| Parameter     | Type   |                                                                                                                                                               |
| ------------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| token_type    | string | Always "Bearer"                                                                                                                                               |
| access_token  | string | An access token valid to consult other endpoints on behalf of the user                                                                                        |
| expires_in    | string | Expiration time of the access token in seconds                                                                                                                |
| refresh_token | string | An refresh token valid to renew the access token. It does not expires.                                                                                        |
| scope         | string | The scopes with granted access for this token                                                                                                                 |
| advisor_id    | int    | The ID of the advisor associated to this user                                                                                                                 |
| session_token | string | A short-lived token used to start a session in stratifi.com (<a href="https://api.stratifi.com/docs/v1/#starting-a-session-in-stratifi-com">more details</a>) |

&#54;. Include the _Authorization_ header in your requests as follows:

<!-- (Hardcode the 6. because at this point the format is mess between the list, table and the shell code) -->

    `Authorization: Bearer {{ access-token }}`

## Refresh Token Flow

If your access token expired you can renew it using a valid refresh token.

```shell
curl -X POST "https://backend.stratifi.com/o/token/" \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=refresh_token' \
  --data-urlencode 'client_id={{ client_id }}' \
  --data-urlencode 'client_secret={{ secret_key }}' \
  --data-urlencode 'refresh_token={{ refresh_token }}'

{
    "access_token": "{{ access_token }}",
    "token_type": "Bearer",
    "expires_in": 3600,
    "refresh_token": "{{ refresh_token }}",
    "scope": "read write",
    "advisor_id": 1,
    "session_token": "{{ session_token }}

}
```

**Request Parameters**

| Parameter     | Type   |                             |
| ------------- | ------ | --------------------------- |
| grant_type    | string | Always "refresh_token"      |
| refresh_token | string | Your Refresh Token          |
| client_id     | string | Your application client id  |
| client_secret | string | Your application secret key |

**Response**

| Parameter     | Type   |                                                                                                                                                               |
| ------------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| token_type    | string | Always "Bearer"                                                                                                                                               |
| access_token  | string | An access token valid to consult other endpoints on behalf of the user                                                                                        |
| expires_in    | string | Expiration time of the access token in seconds                                                                                                                |
| refresh_token | string | An refresh token valid to renew the access token                                                                                                              |
| scope         | string | The scopes with granted access for this token                                                                                                                 |
| advisor_id    | int    | The ID of the advisor associated to this user                                                                                                                 |
| session_token | string | A short-lived token used to start a session in stratifi.com (<a href="https://api.stratifi.com/docs/v1/#starting-a-session-in-stratifi-com">more details</a>) |

## Starting a session in stratifi.com

The authorization responses described above contain a **session_token** property. This token automatically
authenticates advisors in stratifi.com, meaning that the advisor won't be required to fill the credentials when visiting Stratifi.

To build an authenticated URL you need 3 parts:

- **Base domain:** `advisors-sandbox.stratifi.com` (sandbox) or `advisors.stratifi.com` (production)
- **Session Token:** Received during the authorization flow.
- **Path:** The path you want to visit. You may be particularly interested in the following ones:

| Description               | URL                         |
| ------------------------- | --------------------------- |
| Clients list              | `/advisor/investors/`       |
| Clients overview          | `/advisor/investors/<id>/`  |
| Prospects list            | `/advisor/prospects/`       |
| Prospects overview        | `/advisor/prospects/<id>/`  |
| Households list           | `/advisor/households/`      |
| Households overview       | `/advisor/households/<id>/` |
| Model Portfolios list     | `/advisor/models/`          |
| Model Portfolios overview | `/advisor/models/<id>/`     |

Having these 3 elements, the full URL is: `https://{{ base_domain}}{{ path }}?session={{ sesison_token }}`

For instance, `https://advisors-sandbox.stratifi.com/advisor/investors/1/?session=abc123` will lead the user
to the details page of the client with id 1 in the sandbox environment.

<small>Note: The session token has a life of 5 minutes. After that, you will need to follow the refresh token flow to get a new one. If you use an expired token in an URL, the user will be redirected to the signin page in Stratifi.</small>

## Retrieving logged user information

You can get basic information about the user related to a token by consulting the `/userinfo` endpoint.
The response includes the advisor ID and the **session_token** described above.

```shell
curl -X GET "https://backend.stratifi.com/api/v1/userinfo/"

{
    "first_name":"John",
    "last_name":"Wick",
    "email":"john.wick@example.com",
    "advisor_id": 1,
    "session_token": "{{ session_token }}
}
```

**Response**

| Name          | Type   | Description                                                                                                                                                   |
| ------------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| first_name    | string | User first name                                                                                                                                               |
| last_name     | string | User last name                                                                                                                                                |
| email         | string | User email address                                                                                                                                            |
| advisor_id    | int    | The ID of the advisor associated to this user                                                                                                                 |
| session_token | string | A short-lived token used to start a session in stratifi.com (<a href="https://api.stratifi.com/docs/v1/#starting-a-session-in-stratifi-com">more details</a>) |
